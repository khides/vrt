name: Figma Design Comparison

on:
  pull_request:
    paths:
      - 'src/components/**'
      - 'src/design-tokens/**'
      - 'scripts/design-compare/**'

jobs:
  compare:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - run: pnpm install

      - name: Install Playwright Browsers
        run: pnpm exec playwright install chromium

      - name: Build Storybook
        run: pnpm build-storybook

      - name: Start Storybook Server
        run: |
          pnpm exec http-server storybook-static -p 6007 -s &
          npx wait-on http://localhost:6007

      - name: Run Figma Comparison
        run: pnpm design:compare
        env:
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
          STORYBOOK_URL: http://localhost:6007
        continue-on-error: true

      - name: Upload Diff Report
        uses: actions/upload-artifact@v4
        with:
          name: figma-diff-report
          path: reports/figma-diff/
          retention-days: 7

      - name: Comment PR with Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'reports/figma-diff/results.json';

            let comment = '## üé® Figma Design Comparison Results\n\n';

            if (!fs.existsSync(resultsPath)) {
              comment += '‚ö†Ô∏è No comparison results found. This may be because:\n';
              comment += '- `FIGMA_ACCESS_TOKEN` secret is not configured\n';
              comment += '- The Figma mapping file has no valid mappings\n\n';
              comment += 'To set up Figma comparison, add your Figma access token as a repository secret.';
            } else {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf-8'));

              comment += '| Status | Component | Diff |\n';
              comment += '|--------|-----------|------|\n';

              for (const r of results) {
                const status = r.diffPercentage < 5 ? '‚úÖ' : r.diffPercentage < 15 ? '‚ö†Ô∏è' : '‚ùå';
                comment += `| ${status} | ${r.description} | ${r.diffPercentage.toFixed(2)}% |\n`;
              }

              const hasFailures = results.some(r => r.diffPercentage >= 15);
              const hasWarnings = results.some(r => r.diffPercentage >= 5 && r.diffPercentage < 15);

              if (hasFailures) {
                comment += '\n‚ö†Ô∏è **Some components have significant visual differences from Figma.**\n';
                comment += 'Please review the diff report in the workflow artifacts.';
              } else if (hasWarnings) {
                comment += '\n‚ö° **Some minor visual differences detected.** Please review if these are intentional.';
              } else {
                comment += '\n‚úÖ **All components match Figma designs within tolerance.**';
              }
            }

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.body.includes('Figma Design Comparison Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
